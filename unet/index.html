
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../about/">
      
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>UNet - E3TTS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#unet" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="E3TTS" class="md-header__button md-logo" aria-label="E3TTS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            E3TTS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              UNet
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../about/" class="md-tabs__link">
        
  
  
    
  
  E3tts

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  UNet

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="E3TTS" class="md-nav__button md-logo" aria-label="E3TTS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    E3TTS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    E3tts
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    UNet
  

    
  </span>
  
  

      </a>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="unet">UNet</h1>
<p>UNet model architecture is widely used across different models. This model gained traction from paper on image segmentation which is <strong>U-Net: Convolution Networks for Biomedical Image Segmentation</strong>. This model has downsampling and upsampling part. 
<img alt="UNet Diagram" src="../img/UNet.png" />
<center><i>UNet Structure: DBlock for downsampling block, UBlock for upsampling block</i></center></p>
<h1 id="implementation">Implementation</h1>
<p>This model takes the image tile and outputs segmentation map. To make this model let's assume the input image tile as following:
$$
X \in \mathbb{R}^{572 \times 572}
$$</p>
<p>First model will have the input convolution in which the input image tile is mapped from 1 channel to 64 channels. Then it will pass through series of downsampling blocks. Output of each downsampling blocks will be appended to a list except the last one, which will be used for skip connection. The output of downsampling Mudulelist will be fed into series of updampling blocks which will give feature map with 64 channels. This is finally fed into the output convolution mapping to the final 2 channels.</p>
<pre><code class="language-python">input_conv = nn.Sequential(
    nn.Conv2d(1, base_channel, 3, padding=0),
    nn.Conv2d(base_channel, base_channel, 3, padding=0)
)
</code></pre>
<p><center><b>Input Convolution</b></center></p>
<pre><code class="language-python">for idx, mult in enumerate(channel_mult):
    if idx == 0:
        in_channel = base_channel
        out_channel = base_channel * mult
    else:
        in_channel = out_channel
        out_channel = base_channel * mult

    downsampling_blocks.append(
        nn.Sequential(
            nn.MaxPool2d(2),
            nn.Conv2d(in_channel, out_channel, 3, padding=0),
            nn.Conv2d(out_channel, out_channel, 3, padding=0)
        )
    )
</code></pre>
<p><center><b>Downsampling Layers</b></center></p>
<pre><code class="language-python">rev_channel_mult = channel_mult[::-1]
for idx, mult in enumerate(rev_channel_mult):
    if idx == len(rev_channel_mult) - 1:
        in_channel = base_channel * mult
        out_channel = base_channel
    else:
        in_channel = base_channel * mult
        out_channel = base_channel * rev_channel_mult[idx+1]

    upsampling_blocks.append(
        nn.Sequential(
            nn.ConvTranspose2d(in_channel, out_channel, 2, stride=2, padding=0),
            nn.Conv2d(in_channel, out_channel, 3, padding=0),
            nn.Conv2d(out_channel, out_channel, 3, padding=0)
        )
    )
</code></pre>
<p><center><b>Upsampling Layers</b></center></p>
<pre><code class="language-python">out_conv = nn.Conv2d(base_channel, 2, 3, padding=0)
</code></pre>
<p><center><b>Output Convolution</b></center></p>
<pre><code class="language-python"># Forward Pass
x = torch.randn(1, 1, 572, 572) # (B, C, H, W)

# Encoder path - store skip connections
skip_connections = []

# Input Convolution
h = input_conv(x)
skip_connections.append(h)

for i, d_block in enumerate(downsampling_blocks):
    h = d_block(h)

    if i &lt; len(downsampling_blocks) - 1:
        skip_connections.append(h)

# Reverse the skip connections to match the order of upsampling order
skip_connections = skip_connections[::-1]

# Decoder path - use skip connections
for i, u_block in enumerate(upsampling_blocks):
    h = u_block[0](h)

    skip = skip_connections[i]

    # Crop skip connection if needed (to match the spatial dimensions)
    # This handles cases where the dimensions don't match exactly
    _, _, h_h, h_w = h.shape
    _, _, s_h, s_w = skip.shape

    if h_h != s_h or h_w != s_w:
        # Center crop the skip connection
        diff_h = (s_h - h_h) // 2
        diff_w = (s_w - h_w) // 2
        skip = skip[:, :, diff_h:s_h-diff_h, diff_w:s_w-diff_w]

    # Concatenate along channel dimension
    h = torch.cat([h, skip], dim=1)

    # Apply remaining convolutions
    h = u_block[1](h)  # First Conv2d (handles doubled channels)
    h = u_block[2](h)  # Second Conv2d

# Final output convolution
h = out_conv(h)
logger.info(f&quot;Final output shape: {h.shape}&quot;)
</code></pre>
<p><center><b>Sample for Forward Pass</b></center></p>
<h2 id="final-model">Final Model</h2>
<pre><code class="language-python">class UNet(nn.Module):
    def __init__(self, channel_mult, base_channel):
        super(UNet, self).__init__()
        self.channel_mult = channel_mult
        self.base_channel = base_channel

        self.input_conv = nn.Sequential(
            nn.Conv2d(1, base_channel, 3, padding=0),
            nn.Conv2d(base_channel, base_channel, 3, padding=0)
        )

        self.downsampling_blocks = nn.ModuleList()
        self.upsampling_blocks = nn.ModuleList()

        for idx, mult in enumerate(channel_mult):
            if idx == 0:
                in_channel = base_channel
                out_channel = base_channel * mult
            else:
                in_channel = out_channel
                out_channel = base_channel * mult

            self.downsampling_blocks.append(
                nn.Sequential(
                    nn.MaxPool2d(2),
                    nn.Conv2d(in_channel, out_channel, 3, padding=0),
                    nn.Conv2d(out_channel, out_channel, 3, padding=0)
                )
            )

        for idx, mult in enumerate(channel_mult[::-1]):
            if idx == len(channel_mult[::-1]) - 1:
                in_channel = base_channel * mult
                out_channel = base_channel
            else:
                in_channel = base_channel * mult
                out_channel = base_channel * channel_mult[::-1][idx+1]

            self.upsampling_blocks.append(
                nn.Sequential(
                    nn.ConvTranspose2d(in_channel, out_channel, 2, stride=2, padding=0),
                    nn.Conv2d(in_channel, out_channel, 3, padding=0),
                    nn.Conv2d(out_channel, out_channel, 3, padding=0)
                )
            )

        self.out_conv = nn.Conv2d(base_channel, 2, 3, padding=0)

    def forward(self, x):
        &quot;&quot;&quot;
        Args:
            x: Tensor of shape (B, 1, H, W)
        Returns:
            Tensor of shape (B, 2, H, W)
        &quot;&quot;&quot;
        h = self.input_conv(x)
        skip_connections = []
        for i, d_block in enumerate(self.downsampling_blocks):
            h = d_block(h)

            if i &lt; len(self.downsampling_blocks) - 1:
                skip_connections.append(h)

        # Reverse the skip connections to match the order of upsampling order
        skip_connections = skip_connections[::-1]
        # Decoder path - use skip connections
        for i, u_block in enumerate(self.upsampling_blocks):
            h = u_block[0](h)

            skip = skip_connections[i]

            # Crop skip connection if needed (to match the spatial dimensions)
            # This handles cases where the dimensions don't match exactly
            _, _, h_h, h_w = h.shape
            _, _, s_h, s_w = skip.shape

            if h_h != s_h or h_w != s_w:
                # Center crop the skip connection
                diff_h = (s_h - h_h) // 2
                diff_w = (s_w - h_w) // 2
                skip = skip[:, :, diff_h:s_h-diff_h, diff_w:s_w-diff_w]

            # Concatenate along channel dimension
            h = torch.cat([h, skip], dim=1)

            # Apply remaining convolutions
            h = u_block[1](h)  # First Conv2d (handles doubled channels)
            h = u_block[2](h)  # Second Conv2d

        # Final output convolution
        h = self.out_conv(h)
        return h
</code></pre>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.tabs", "navigation.top", "search.highlight", "search.suggest", "toc.integrate", "content.code.annotate", "content.code.copy", "content.tabs.link"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>